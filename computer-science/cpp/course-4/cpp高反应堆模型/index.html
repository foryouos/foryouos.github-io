<!-- build time: Sun Aug 27 2023 15:11:59 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="referrer" content="never"><meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1"><meta name="renderer" content="webkit"><link rel="icon" type="image/ico" sizes="32x32" href="/assets/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><meta name="baidu-site-verification" content="codeva-yIAXMzOV6I"><link rel="alternate" href="/rss.xml" title="瓶子的跋涉" type="application/rss+xml"><link rel="alternate" href="/atom.xml" title="瓶子的跋涉" type="application/atom+xml"><link rel="alternate" type="application/json" title="瓶子的跋涉" href="https://www.blog.foryouos.cn/feed.json"><link rel="preconnect" href="https://lf9-cdn-tos.bytecdntp.com"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://unpkg.com"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.3.5"><script src="https://cdn.staticfile.org/vue/3.2.45/vue.global.prod.js"></script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"><meta name="keywords" content="Linux,计算机科学,"><link rel="canonical" href="https://www.blog.foryouos.cn/computer-science/cpp/course-4/cpp%E9%AB%98%E5%8F%8D%E5%BA%94%E5%A0%86%E6%A8%A1%E5%9E%8B/"><title>Linux后台服务器C++</title><meta name="generator" content="Hexo 6.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Linux后台服务器C++</h1><div class="meta"><span class="item" title="创建时间：2023-07-04 11:20:43"><span class="icon"><i class="ic i-calendar"></i></span><span class="text">发表于</span><time itemprop="dateCreated datePublished" datetime="2023-07-04T11:20:43+08:00">2023-07-04</time></span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i></span><span class="text">本文字数</span><span>19k</span><span class="text">字</span></span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i></span><span class="text">阅读时长</span><span>17 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span><span class="line"></span><span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">foryouos</a></li></ul><ul class="right" id="rightNav"><li class="item theme" @click="changeThemeByBtn"><i class="ic" :class="{'i-sun': !themeStatus,'i-moon': themeStatus}"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div class="pjax" id="imgs"><img src="https://i.imgtg.com/2023/07/04/OxFifa.webp"></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"></use><use xlink:href="#gentle-wave" x="48" y="3"></use><use xlink:href="#gentle-wave" x="48" y="5"></use><use xlink:href="#gentle-wave" x="48" y="7"></use></g></svg></div><main><div class="inner"><div class="pjax" id="main"><div class="article wrap"><div class="breadcrumb" itemlistelement itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i><span><a href="/">首页</a></span><i class="ic i-angle-right"></i><span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/computer-science/" itemprop="item" rel="index" title="分类于计算机科学"><span itemprop="name">计算机科学<meta itemprop="position" content="0"></span></a></span><i class="ic i-angle-right"></i><span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/computer-science/cpp/" itemprop="item" rel="index" title="分类于C++"><span itemprop="name">C++<meta itemprop="position" content="1"></span></a></span><i class="ic i-angle-right"></i><span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/computer-science/cpp/course-4/" itemprop="item" rel="index" title="分类于C和C++项目"><span itemprop="name">C和C++项目<meta itemprop="position" content="2"></span></a></span></div><article class="post block" itemscope itemtype="http://schema.org/Article" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.blog.foryouos.cn/computer-science/cpp/course-4/cpp%E9%AB%98%E5%8F%8D%E5%BA%94%E5%A0%86%E6%A8%A1%E5%9E%8B/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/assets/avatar.jpg"><meta itemprop="name" content="YuHeShui"><meta itemprop="description" content="YuHeShui, 瓶子的跋涉 &amp; 编程笔记"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="瓶子的跋涉"></span><div class="body md" itemprop="articleBody"><h1 id="基于reactor高并发服务器-c"><a class="anchor" href="#基于reactor高并发服务器-c">#</a> 基于 <code>Reactor</code> 高并发服务器 <code>C++</code></h1><blockquote><p>基于 <code>Reactor</code> 的高并发服务器，分为 <code>反应堆模型</code> ， <code>多线程</code> ， <code>I/O模型</code> ， <code>服务器</code> ， <code>Http请求</code> 和 <code>响应</code> 五部分</p></blockquote><p><img data-src="https://mmbiz.qpic.cn/mmbiz_jpg/ORog4TEnkbvYbuq71ib9iaeQVznZ5coWayVyHeW1u9lLN9erbib5Gl9iaFzzueNicVmZLTYkp7MbpD5c6BZRjC6fOMg/640?wx_fmt=jpeg" alt="全局" title="全局反应堆模型"></p><h1 id="反应堆模型"><a class="anchor" href="#反应堆模型">#</a> 反应堆模型</h1><h2 id="channel"><a class="anchor" href="#channel">#</a> <code>Channel</code></h2><blockquote><p>描述了文件描述符以及 <code>读写事件</code> ，以及对应的读写销毁回调函数，对应存储 <code>arg</code> 读写回调对应的参数</p></blockquote><p><img data-src="https://mmbiz.qpic.cn/mmbiz_jpg/ORog4TEnkbvYbuq71ib9iaeQVznZ5coWayyXibpORz5m3TBibibqWYoznveXiasCfgkcHPu5vkr9W7WLoSxTsZJBLlWg/640?wx_fmt=jpeg" alt="Channel" title="channel"></p><h2 id="channel添加写和判断"><a class="anchor" href="#channel添加写和判断">#</a> Channel 添加写和判断</h2><blockquote><ul><li><p>异或 <code>|</code> ： <code>相同为0</code> ， <code>异为1</code></p></li><li><p>按位与 <code>&amp;</code> ：只有 11 为 1，其它组合全部为 0，即只有 <code>真真为真</code> ，其它 <code>一假则假</code></p></li><li><p>去反 <code>~</code> ：二进制 <code>全部取反</code></p></li><li><p><code>添加写属性</code> ：若对应为 10 想要写添加写属性，与 100 <code>异或</code> ，的 110 读写属性</p></li><li><p><code>删除写属性</code> ：第三位 <code>清零</code> ，若为 110，第三位清零，将写取 <code>反011</code> ，在按位与 &amp; 010 只 <code>留下读事件</code></p></li></ul></blockquote><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// C++11 强类型枚举</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">enum</span> <span class="token keyword">class</span> <span class="token class-name">FDEvent</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	TimeOut <span class="token operator">=</span> <span class="token number">0x01</span><span class="token punctuation">,</span>       <span class="token comment">// 十进制 1，超时了 1</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	ReadEvent <span class="token operator">=</span> <span class="token number">0x02</span><span class="token punctuation">,</span>    <span class="token comment">// 十进制 2       10</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	WriteEvent <span class="token operator">=</span> <span class="token number">0x04</span>   <span class="token comment">// 十进制 4  二进制 100</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">void</span> <span class="token class-name">Channel</span><span class="token double-colon punctuation">::</span><span class="token function">writeEventEnable</span><span class="token punctuation">(</span><span class="token keyword">bool</span> flag<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token comment">// 如果为真，添加写属性</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>		<span class="token comment">// 异或 相同为 0 异为 1</span></pre></td></tr><tr><td data-num="13"></td><td><pre>		<span class="token comment">// WriteEvent 从右往左数第三个标志位 1，通过异或 让 channel->events 的第三位为 1</span></pre></td></tr><tr><td data-num="14"></td><td><pre>		m_events <span class="token operator">|=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>FDEvent<span class="token double-colon punctuation">::</span>WriteEvent<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 按位异或 int events 整型 32 位，0/1,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	<span class="token keyword">else</span> <span class="token comment">// 如果不写，让 channel->events 对应的第三位清零</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>		<span class="token comment">// ~WriteEvent 按位与， ~WriteEvent 取反 011 然后与 channel->events 按位与 & amp; 运算 只有 11 为 1，其它皆为 0 只有同为真时则真，一假则假，1 为真，0 为假</span></pre></td></tr><tr><td data-num="19"></td><td><pre>		m_events <span class="token operator">=</span> m_events <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>FDEvent<span class="token double-colon punctuation">::</span>WriteEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//channel->events 第三位清零之后，写事件就不再检测</span></pre></td></tr><tr><td data-num="20"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment">// 判断文件描述符是否有写事件</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">bool</span> <span class="token class-name">Channel</span><span class="token double-colon punctuation">::</span><span class="token function">isWriteEventEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>	<span class="token keyword">return</span> m_events <span class="token operator">&amp;</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>FDEvent<span class="token double-colon punctuation">::</span>WriteEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 按位与 ，第三位都是 1，则是写，如果成立，最后大于 0，如果不成立，最后为 0</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="dispatcher"><a class="anchor" href="#dispatcher">#</a> <code>Dispatcher</code></h2><blockquote><p><code>Dispatcher</code> 作为 <code>父类</code> 函数，对应 <code>Epoll</code> , <code>Poll</code> , <code>Select模型</code> 。</p></blockquote><p><img data-src="https://mmbiz.qpic.cn/mmbiz_jpg/ORog4TEnkbvYbuq71ib9iaeQVznZ5coWayFoicEL0lDZhBQib2so4J0dGkjFmdkKzG1KeQKRQoqibRIu3UNmdp6z6sw/640?wx_fmt=jpeg" alt="反应堆模型" title="反应堆模型"></p><h2 id="选择反应堆模型"><a class="anchor" href="#选择反应堆模型">#</a> 选择反应堆模型</h2><blockquote><p>在 <code>EventLoop</code> 初始化时，针对 <code>全局EventLoop</code> , 将 <code>m_dispatcher</code> 初始化为 <code>EpollDispatcher</code> .</p><p>使用 <code>多态性</code> ， <code>父类</code> 建立 <code>虚</code> 函数， <code>子类</code> 继承复函数，使用 <code>override</code> 取代 <code>父类虚函数</code> 。达到选择反应堆模型。</p></blockquote><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre>m_dispatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">EpollDispatcher</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 选择模型</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">//Dispatcher 类为父类</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">Dispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 也虚函数，在多态时</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">virtual</span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 等于 = 0 纯虚函数，就不用定义</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// 删除 将某一个节点从 epoll 树上删除</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">virtual</span> <span class="token keyword">int</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">// 修改</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">virtual</span> <span class="token keyword">int</span> <span class="token function">modify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">// 事件检测， 用于检测待检测三者之一模型 epoll_wait 等的一系列事件上是否有事件被激活，读 / 写事件</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">virtual</span> <span class="token keyword">int</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token keyword">int</span> timeout <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 单位 S 超时时长</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">//Epoll 子类继承父类，override 多态性覆盖父类函数，同时 public 继承，继承 Dispatcher 的私有变量</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">EpollDispatcher</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Dispatcher</span>  <span class="token comment">// 继承父类 Dispatcher</span></span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">public</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token function">EpollDispatcher</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">EventLoop</span><span class="token operator">*</span> evLoop<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token operator">~</span><span class="token function">EpollDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 也虚函数，在多态时</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">//override 修饰前面的函数，表示此函数是从父类继承过来的函数，子类将重写父类虚函数</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">//override 会自动对前面的名字进行检查，</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">override</span><span class="token punctuation">;</span>   <span class="token comment">// 等于 = 纯虚函数，就不用定义 </span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment">// 删除 将某一个节点从 epoll 树上删除</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">int</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">override</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">// 修改</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">int</span> <span class="token function">modify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">override</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment">// 事件检测， 用于检测待检测三者之一模型 epoll_wait 等的一系列事件上是否有事件被激活，读 / 写事件</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token keyword">int</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token keyword">int</span> timeout <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">override</span><span class="token punctuation">;</span><span class="token comment">// 单位 S 超时时长</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token comment">// 不改变的不写，直接继承父类</span></pre></td></tr></table></figure><h2 id="eventloop"><a class="anchor" href="#eventloop">#</a> <code>EventLoop</code></h2><blockquote><p>处理 <code>所有的事件</code> ，启动反应堆模型，处理机会 <code>文件描述符后的事件,添加任务，处理</code> 任务队列<br>调用 <code>dispatcher</code> 中的 <code>添加移除，修改</code> 操作<br>存储着任务队列 <code>m_taskQ</code> 存储 <code>fd和对应channel对应关系</code> : <code>m_channelmap</code></p></blockquote><h3 id="私有函数变量"><a class="anchor" href="#私有函数变量">#</a> 私有函数变量</h3><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// CHannelElement 结构体</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 定义任务队列的节点 类型，文件描述符信息</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">ChannelElement</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	ElemType type<span class="token punctuation">;</span>       <span class="token comment">// 如何处理该节点中 Channel</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	Channel<span class="token operator">*</span> channel<span class="token punctuation">;</span>   <span class="token comment">// 文件描述符信息</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">// 私有函数变量</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">// 加入开关 EventLoop 是否工作</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">bool</span> m_isQuit<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">// 该指针指向之类的实例 epoll,poll,select</span></pre></td></tr><tr><td data-num="13"></td><td><pre>Dispatcher<span class="token operator">*</span> m_dispatcher<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">// 任务队列，存储任务，遍历任务队列就可以修改 dispatcher 检测的文件描述符</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">// 任务队列</span></pre></td></tr><tr><td data-num="16"></td><td><pre>queue<span class="token operator">&lt;</span>ChannelElement<span class="token operator">*</span><span class="token operator">></span>m_taskQ<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">//map 文件描述符和 Channel 之间的对应关系  通过数组实现</span></pre></td></tr><tr><td data-num="18"></td><td><pre>map<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span>Channel<span class="token operator">*</span><span class="token operator">></span> m_channelmap<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">// 线程相关，线程 ID，name</span></pre></td></tr><tr><td data-num="20"></td><td><pre>thread<span class="token double-colon punctuation">::</span>id m_threadID<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>string m_threadName<span class="token punctuation">;</span>  <span class="token comment">// 主线程只有一个，固定名称，初始化要分为两个</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment">// 互斥锁，保护任务队列</span></pre></td></tr><tr><td data-num="23"></td><td><pre>mutex m_mutex<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">// 整型数组</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">int</span> m_socketPair<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 存储本地通信 fd 通过 socketpair 初始化</span></pre></td></tr></table></figure><p><img data-src="https://mmbiz.qpic.cn/mmbiz_jpg/ORog4TEnkbvYbuq71ib9iaeQVznZ5coWayzpdqwL3ECRhgnsNDctWflow9wjaZXVH5JrbFVhHic6mHQtZzwHCYusA/640?wx_fmt=jpeg" alt="EventLoop事件处理" title="EventLoop事件处理"></p><p><img data-src="https://mmbiz.qpic.cn/mmbiz_jpg/ORog4TEnkbvYbuq71ib9iaeQVznZ5coWayECvsG4dWSPJUQJoBuD7CBKibb6N4PG2MWQspZc0SEv7bun0oQibu6HJA/640?wx_fmt=jpeg" alt="m_channelmap"></p><p><img data-src="https://mmbiz.qpic.cn/mmbiz_jpg/ORog4TEnkbvYbuq71ib9iaeQVznZ5coWay1oou6Elyuzqa0qsuibI4y1HBzOybIiavaCiaEcvjKXI97BVDzZTySbXIw/640?wx_fmt=jpeg" alt="任务队列ChannelElement" title="任务队列ChannelElement"></p><p><img data-src="https://mmbiz.qpic.cn/mmbiz_jpg/ORog4TEnkbvYbuq71ib9iaeQVznZ5coWayUuRJVjicERYwdgibPnfXprfwWDX2SDIhcYUFYfI6oCd2sekDL2RvMnNw/640?wx_fmt=jpeg" alt="任务队列" title="任务队列list"></p><h3 id="反应堆运行"><a class="anchor" href="#反应堆运行">#</a> 反应堆运行</h3><blockquote><p>反应堆模型启动之后将会在 <code>while循环</code> 中一直执行下去。首先调用 <code>dispatcher</code> 调用 <code>Epoll的wait函数</code> ，等待内核回应，根据其读写请求调用 <code>evLoop</code> 的 <code>enactive</code> 函数进行相关的读写操作。</p></blockquote><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span> <span class="token class-name">EventLoop</span><span class="token double-colon punctuation">::</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    m_isQuit <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 不退出</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 比较线程 ID，当前线程 ID 与我们保存的线程 ID 是否相等</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_threadID <span class="token operator">!=</span> this_thread<span class="token double-colon punctuation">::</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token comment">// 不相等时 直接返回 - 1</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// 循环进行时间处理</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_isQuit<span class="token punctuation">)</span> <span class="token comment">// 只要没有停止 死循环</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token comment">// 调用初始化时选中的模型 Epoll,Poll，Select</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        m_dispatcher<span class="token operator">-></span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token function">ProcessTaskQ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 处理任务队列</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="enactive"><a class="anchor" href="#enactive">#</a> enactive</h3><blockquote><p>根据传入的 <code>event</code> 调用对应 <code>Channel</code> 对应的 <code>读写回调函数</code></p></blockquote><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span> <span class="token class-name">EventLoop</span><span class="token double-colon punctuation">::</span><span class="token function">eventActive</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> event<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 判断函数传入的参数是否为有效</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// 基于 fd 从 EventLoop 取出对应的 Channel</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    Channel<span class="token operator">*</span> channel <span class="token operator">=</span> m_channelmap<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//channelmap 根据对应的 fd 取出对应的 channel</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// 判断取出 channel 的 fd 与当前的 fd 是否相同</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token function">assert</span><span class="token punctuation">(</span>channel<span class="token operator">-></span><span class="token function">getSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果为假，打印出报错信息</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>FDEvent<span class="token double-colon punctuation">::</span>ReadEvent <span class="token operator">&amp;&amp;</span> channel<span class="token operator">-></span>readCallback<span class="token punctuation">)</span> <span class="token comment">//channel->readCallback 不等于空</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token comment">// 调用 channel 的读回调函数</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        channel<span class="token operator">-></span><span class="token function">readCallback</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">const_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>channel<span class="token operator">-></span><span class="token function">getArg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>FDEvent<span class="token double-colon punctuation">::</span>WriteEvent <span class="token operator">&amp;&amp;</span> channel<span class="token operator">-></span>writeCallback<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        channel<span class="token operator">-></span><span class="token function">writeCallback</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">const_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>channel<span class="token operator">-></span><span class="token function">getArg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="添加任务"><a class="anchor" href="#添加任务">#</a> 添加任务</h3><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span> <span class="token class-name">EventLoop</span><span class="token double-colon punctuation">::</span><span class="token function">AddTask</span><span class="token punctuation">(</span>Channel<span class="token operator">*</span> channel<span class="token punctuation">,</span> ElemType type<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 加锁，有可能是当前线程，也有可能是主线程</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// 创建新节点</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    ChannelElement<span class="token operator">*</span> node <span class="token operator">=</span> <span class="token keyword">new</span> ChannelElement<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    node<span class="token operator">-></span>channel <span class="token operator">=</span> channel<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    node<span class="token operator">-></span>type <span class="token operator">=</span> type<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    m_taskQ<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// 处理节点</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">/*</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    * 如当前 EventLoop 反应堆属于子线程</pre></td></tr><tr><td data-num="14"></td><td><pre>    *   1，对于链表节点的添加：可能是当前线程也可能是其它线程 (主线程)</pre></td></tr><tr><td data-num="15"></td><td><pre>    *       1), 修改 fd 的事件，可能是当前线程发起的，还是当前子线程进行处理</pre></td></tr><tr><td data-num="16"></td><td><pre>    *       2), 添加新的 fd，和新的客户端发起连接，添加任务节点的操作由主线程发起</pre></td></tr><tr><td data-num="17"></td><td><pre>    *   2，主线程只负责和客户端建立连接，判断当前线程，不让主线程进行处理，分给子线程</pre></td></tr><tr><td data-num="18"></td><td><pre>    *       不能让主线程处理任务队列，需要由当前的子线程处理</pre></td></tr><tr><td data-num="19"></td><td><pre>    */</pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_threadID <span class="token operator">==</span> this_thread<span class="token double-colon punctuation">::</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token comment">// 当前子线程</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token comment">// 直接处理任务队列中的任务</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token function">ProcessTaskQ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">else</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token comment">// 主线程 -- 告诉子线程处理任务队列中的任务</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token comment">// 1, 子线程在工作 2，子线程被阻塞了：1，select,poll,epoll, 如何解除其阻塞，在本代码阻塞时长是 2s</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token comment">// 在检测集合中添加属于自己 (额外) 的文件描述，不负责套接字通信，目的控制文件描述符什么时候有数据，辅助解除阻塞</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token comment">// 满足条件，两个文件描述符，可以相互通信，//1，使用 pipe 进程间通信，进程更可，//2，socketpair 文件描述符进行通信</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token function">taskWakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 主线程调用，相当于向 socket 添加了数据</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="处理任务"><a class="anchor" href="#处理任务">#</a> 处理任务</h3><blockquote><p>从任务队列中取出一个 <code>任务</code> ，根据 <code>其任务类型</code> ，调用 <code>反应堆模型对应</code> ，将 <code>channel</code> 在内核中的检测进行 <code>删除</code> ， <code>修改</code> ，或 <code>添加</code></p></blockquote><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span> <span class="token class-name">EventLoop</span><span class="token double-colon punctuation">::</span><span class="token function">ProcessTaskQ</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 遍历链表</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>m_taskQ<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token comment">// 将处理后的 task 从当前链表中删除，(需要加锁)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token comment">// 取出头结点</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        ChannelElement<span class="token operator">*</span> node <span class="token operator">=</span> m_taskQ<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 从头部</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        m_taskQ<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 把头结点弹出，相当于删除 </span></pre></td></tr><tr><td data-num="11"></td><td><pre>        </pre></td></tr><tr><td data-num="12"></td><td><pre>        m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token comment">// 读链表中的 Channel, 根据 Channel 进行处理</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        Channel<span class="token operator">*</span> channel <span class="token operator">=</span> node<span class="token operator">-></span>channel<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token comment">// 判断任务类型</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token operator">-></span>type <span class="token operator">==</span> ElemType<span class="token double-colon punctuation">::</span>ADD<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token comment">// 需要 channel 里面的文件描述符 evLoop 里面的数据</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token comment">// 添加  -- 每个功能对应一个任务函数，更利于维护</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token function">Add</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token operator">-></span>type <span class="token operator">==</span> ElemType<span class="token double-colon punctuation">::</span>DELETE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token comment">//Debug ("断开了连接");</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token comment">// 删除</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token function">Remove</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token comment">// 需要资源释放 channel 关掉文件描述符，地址堆内存释放，channel 和 dispatcher 的关系需要删除</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token operator">-></span>type <span class="token operator">==</span> ElemType<span class="token double-colon punctuation">::</span>MODIFY<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token comment">// 修改  的文件描述符事件</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token function">Modify</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token keyword">delete</span> node<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token keyword">int</span> <span class="token class-name">EventLoop</span><span class="token double-colon punctuation">::</span><span class="token function">Add</span><span class="token punctuation">(</span>Channel<span class="token operator">*</span> channel<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token comment">// 把任务节点中的任务添加到 dispatcher 对应的检测集合里面，</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">int</span> fd <span class="token operator">=</span> channel<span class="token operator">-></span><span class="token function">getSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token comment">// 找到 fd 对应数组元素的位置，并存储</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_channelmap<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span> <span class="token operator">==</span> m_channelmap<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        m_channelmap<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token function">make_pair</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> channel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将当前 fd 和 channel 添加到 map</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        m_dispatcher<span class="token operator">-></span><span class="token function">setChannel</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置当前 channel</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token keyword">int</span> ret <span class="token operator">=</span> m_dispatcher<span class="token operator">-></span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 加入</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token keyword">return</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token keyword">int</span> <span class="token class-name">EventLoop</span><span class="token double-colon punctuation">::</span><span class="token function">Remove</span><span class="token punctuation">(</span>Channel<span class="token operator">*</span> channel<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token comment">// 调用 dispatcher 的 remove 函数进行删除</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token comment">// 将要删除的文件描述符</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token keyword">int</span> fd <span class="token operator">=</span> channel<span class="token operator">-></span><span class="token function">getSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token comment">// 判断文件描述符是否已经在检测的集合了</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_channelmap<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span> <span class="token operator">==</span> m_channelmap<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token comment">// 从检测集合中删除 封装了 poll,epoll select</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    m_dispatcher<span class="token operator">-></span><span class="token function">setChannel</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token keyword">int</span> ret <span class="token operator">=</span> m_dispatcher<span class="token operator">-></span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token keyword">return</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="69"></td><td><pre></pre></td></tr><tr><td data-num="70"></td><td><pre><span class="token keyword">int</span> <span class="token class-name">EventLoop</span><span class="token double-colon punctuation">::</span><span class="token function">Modify</span><span class="token punctuation">(</span>Channel<span class="token operator">*</span> channel<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token comment">// 将要修改的文件描述符</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token keyword">int</span> fd <span class="token operator">=</span> channel<span class="token operator">-></span><span class="token function">getSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token comment">// TODO 判断</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>m_channelmap<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span> <span class="token operator">==</span> m_channelmap<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token comment">// 从检测集合中删除</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    m_dispatcher<span class="token operator">-></span><span class="token function">setChannel</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>    <span class="token keyword">int</span> ret <span class="token operator">=</span> m_dispatcher<span class="token operator">-></span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token keyword">return</span> ret<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h1 id="多线程"><a class="anchor" href="#多线程">#</a> 多线程</h1><h2 id="threadpool"><a class="anchor" href="#threadpool">#</a> <code>ThreadPool</code></h2><blockquote><p>定义线程池， <code>运行线程池</code> ， <code>public函数</code> 取出线程池中某个子线程的 <code>反应堆实例EventLoop</code> ，线程池的 <code>EventLoop反应堆模型</code> 事件由主线程传入，属于 <code>主线程</code> ，其 <code>内部</code> ， <code>任务队列</code> ， <code>fd和Channel</code> 对应关系， <code>ChannelElement</code> 都是所有线程需要使用的数据</p></blockquote><p><img data-src="https://mmbiz.qpic.cn/mmbiz_jpg/ORog4TEnkbvYbuq71ib9iaeQVznZ5coWayibztUVcIf3VKUk8pVcWurWN4S4JkhFwBb9tnVicNlxibuBqxLOicb6DpKw/640?wx_fmt=jpeg" alt="线程池工作" title="线程池工作"></p><h3 id="线程池运行创建子工作线程"><a class="anchor" href="#线程池运行创建子工作线程">#</a> 线程池运行创建子工作线程</h3><blockquote><p>线程池运行语句在主线层运行，根据 <code>当前线程数量</code> ，申请响应的 <code>工作线程池</code> ，并将工作线程运行起来，将工作线程加入到线程池的 <code>vector数组</code> 当中。</p></blockquote><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token class-name">ThreadPool</span><span class="token double-colon punctuation">::</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>m_isStart<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 运行期间此条件不能错</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token comment">// 判断是不是主线程</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token keyword">if</span><span class="token punctuation">(</span>m_mainLoop<span class="token operator">-></span><span class="token function">getTHreadID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> this_thread<span class="token double-colon punctuation">::</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token comment">// 将线程池设置状态标志为启动</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	m_isStart <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token comment">// 子线程数量大于 0</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>m_threadNum <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> m_threadNum<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>			WorkerThread<span class="token operator">*</span> subThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">WorkerThread</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用子线程</span></pre></td></tr><tr><td data-num="17"></td><td><pre>			subThread<span class="token operator">-></span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>			m_workerThreads<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>subThread<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="取出工作线程池中的eventloop"><a class="anchor" href="#取出工作线程池中的eventloop">#</a> 取出工作线程池中的 <code>EventLoop</code></h3><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre>EventLoop<span class="token operator">*</span> <span class="token class-name">ThreadPool</span><span class="token double-colon punctuation">::</span><span class="token function">takeWorkerEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token comment">// 由主线程来调用线程池取出反应堆模型</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token function">assert</span><span class="token punctuation">(</span>m_isStart<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 当前程序必须是运行的</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token comment">// 判断是不是主线程</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>m_mainLoop<span class="token operator">-></span><span class="token function">getTHreadID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> this_thread<span class="token double-colon punctuation">::</span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token comment">// 从线程池中找到一个子线层，然后取出里面的反应堆实例</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	EventLoop<span class="token operator">*</span> evLoop <span class="token operator">=</span> m_mainLoop<span class="token punctuation">;</span> <span class="token comment">// 将主线程实例初始化</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>m_threadNum <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>		evLoop <span class="token operator">=</span> m_workerThreads<span class="token punctuation">[</span>m_index<span class="token punctuation">]</span><span class="token operator">-></span><span class="token function">getEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>		<span class="token comment">// 雨露均沾，不能一直是一个 pool->index 线程</span></pre></td></tr><tr><td data-num="16"></td><td><pre>		m_index <span class="token operator">=</span> <span class="token operator">++</span>m_index <span class="token operator">%</span> m_threadNum<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>	<span class="token keyword">return</span> evLoop<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="工作线程运行"><a class="anchor" href="#工作线程运行">#</a> 工作线程运行</h3><blockquote><p>在子线程中申请 <code>反应堆模型</code> ，供子线程在客户端连接时取出，供类 <code>Connection</code> 使用</p></blockquote><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token class-name">WorkerThread</span><span class="token double-colon punctuation">::</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token comment">// 创建子线程，3,4 子线程的回调函数以及传入的参数</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token comment">// 调用的函数，以及此函数的所有者 this</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	m_thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">thread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>WorkerThread<span class="token double-colon punctuation">::</span>Running<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token comment">// 阻塞主线程，让当前函数不会直接结束，不知道当前子线程是否运行结束</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token comment">// 如果为空，子线程还没有初始化完毕，让主线程等一会，等到初始化完毕</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	unique_lock<span class="token operator">&lt;</span>mutex<span class="token operator">></span> <span class="token function">locker</span><span class="token punctuation">(</span>m_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token keyword">while</span> <span class="token punctuation">(</span>m_evLoop <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>		m_cond<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>locker<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">void</span><span class="token operator">*</span> <span class="token class-name">WorkerThread</span><span class="token double-colon punctuation">::</span><span class="token function">Running</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	m_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>	<span class="token comment">// 对 evLoop 做初始化</span></pre></td></tr><tr><td data-num="19"></td><td><pre>	m_evLoop <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">EventLoop</span><span class="token punctuation">(</span>m_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>	m_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>	m_cond<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 唤醒一个主线程的条件变量等待解除阻塞</span></pre></td></tr><tr><td data-num="22"></td><td><pre>	<span class="token comment">// 启动反应堆模型</span></pre></td></tr><tr><td data-num="23"></td><td><pre>	m_evLoop<span class="token operator">-></span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h1 id="io-模型"><a class="anchor" href="#io-模型">#</a> <code>IO</code> 模型</h1><h2 id="buffer"><a class="anchor" href="#buffer">#</a> <code>Buffer</code></h2><blockquote><p><code>读写</code> 内存结构体，添加字符串， <code>接受套接字数据</code> ，将写缓存区数据 <code>发送</code></p></blockquote><p><img data-src="https://mmbiz.qpic.cn/mmbiz_jpg/ORog4TEnkbvYbuq71ib9iaeQVznZ5coWayOWMYdF95GsoRt4michrF54jaMpzh7mXAjoKQ0JHXIF6yOqJrUPZARPA/640?wx_fmt=jpeg" alt="读写位置移动" title="读写位置移动"></p><h3 id="发送目录"><a class="anchor" href="#发送目录">#</a> 发送目录</h3><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span> <span class="token class-name">Buffer</span><span class="token double-colon punctuation">::</span><span class="token function">sendData</span><span class="token punctuation">(</span><span class="token keyword">int</span> socket<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token comment">// 判断 buffer 里面是否有需要发送的数据 得到未读数据即待发送</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token keyword">int</span> readable <span class="token operator">=</span> <span class="token function">readableSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>readable <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>		<span class="token comment">// 发送出去 buffer->data + buffer->readPos 缓存区的位置 + 已经读到的位置</span></pre></td></tr><tr><td data-num="8"></td><td><pre>		<span class="token comment">// 管道破裂 -- 连接已经断开，服务器继续发数据，出现管道破裂 -- TCP 协议</span></pre></td></tr><tr><td data-num="9"></td><td><pre>		<span class="token comment">// 当内核产生信号时，MSG_NOSIGNAL 忽略，继续保持连接</span></pre></td></tr><tr><td data-num="10"></td><td><pre>		<span class="token comment">// Linux 的信号级别高，Linux 大多数信号都会终止信号</span></pre></td></tr><tr><td data-num="11"></td><td><pre>		<span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> m_data <span class="token operator">+</span> m_readPos<span class="token punctuation">,</span> readable<span class="token punctuation">,</span> MSG_NOSIGNAL<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>			<span class="token comment">// 往后移动未读缓存区位置</span></pre></td></tr><tr><td data-num="15"></td><td><pre>			m_readPos <span class="token operator">+=</span> count<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>			<span class="token comment">// 稍微休眠一下</span></pre></td></tr><tr><td data-num="17"></td><td><pre>			<span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1 微妙</span></pre></td></tr><tr><td data-num="18"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>		<span class="token keyword">return</span> count<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="发送文件"><a class="anchor" href="#发送文件">#</a> 发送文件</h3><blockquote><p>发送文件是不需要将读取到的文件 <code>放入缓存</code> 的，直接内核发送提高 <code>文件IO</code> 效率。</p></blockquote><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span> <span class="token class-name">Buffer</span><span class="token double-colon punctuation">::</span><span class="token function">sendData</span><span class="token punctuation">(</span><span class="token keyword">int</span> cfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> off_t offset<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token keyword">while</span> <span class="token punctuation">(</span>offset <span class="token operator">&lt;</span> size<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>		<span class="token comment">// 系统函数，发送文件，linux 内核提供的 sendfile 也能减少拷贝次数</span></pre></td></tr><tr><td data-num="7"></td><td><pre>		<span class="token comment">//sendfile 发送文件效率高，而文件目录使用 send</span></pre></td></tr><tr><td data-num="8"></td><td><pre>		<span class="token comment">// 通信文件描述符，打开文件描述符，fd 对应的文件偏移量一般为空，</span></pre></td></tr><tr><td data-num="9"></td><td><pre>		<span class="token comment">// 单独单文件出现发送不全，offset 会自动修改当前读取位置</span></pre></td></tr><tr><td data-num="10"></td><td><pre>		<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">sendfile</span><span class="token punctuation">(</span>cfd<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">,</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span><span class="token punctuation">(</span>size <span class="token operator">-</span> offset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> errno <span class="token operator">==</span> EAGAIN<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"not data ...."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>			<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"sendfile"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>		count <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>offset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>	<span class="token keyword">return</span> count<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="tcpconnection"><a class="anchor" href="#tcpconnection">#</a> <code>TcpConnection</code></h2><blockquote><p>负责 <code>子线程与客户端</code> 进行通信，分别存储这 <code>读写销毁回调函数</code> -&gt; 调用相关 <code>buffer函数</code> 完成相关的 <code>通信功能</code></p></blockquote><p><img data-src="https://mmbiz.qpic.cn/mmbiz_jpg/ORog4TEnkbvYbuq71ib9iaeQVznZ5coWayFJIuzTia0ibOdic4EeGFqGao0wWwwiaTBKLx254ialoFBlXPVE7xVMAc5vA/640?wx_fmt=jpeg" alt="TcpConnection" title="TcpConnection工作"></p><p><img data-src="https://mmbiz.qpic.cn/mmbiz_jpg/ORog4TEnkbvYbuq71ib9iaeQVznZ5coWay7rlB4x3e64g8HNnLNJRicqJibNicgYZabIicEcC8A9uV6Xz4UNbTGVhrmw/640?wx_fmt=jpeg" alt="主线程" title="主线程"></p><h3 id="初始化"><a class="anchor" href="#初始化">#</a> 初始化</h3><blockquote><p>申请 <code>读写缓存区</code> ，并初始化 <code>Channel</code> ，初始化 <code>子线程与客户端</code> 与 <code>服务器进行通信时回调函数</code></p></blockquote><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">TcpConnection</span><span class="token double-colon punctuation">::</span><span class="token function">TcpConnection</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> EventLoop<span class="token operator">*</span> evloop<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token comment">// 并没有创建 evloop，当前的 TcpConnect 都是在子线程中完成的</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	m_evLoop <span class="token operator">=</span> evloop<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	m_readBuf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Buffer</span><span class="token punctuation">(</span><span class="token number">10240</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//10K</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	m_writeBuf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Buffer</span><span class="token punctuation">(</span><span class="token number">10240</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token comment">// 初始化</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	m_request <span class="token operator">=</span> <span class="token keyword">new</span> HttpRequest<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	m_response <span class="token operator">=</span> <span class="token keyword">new</span> HttpResponse<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>	m_name <span class="token operator">=</span> <span class="token string">"Connection-"</span> <span class="token operator">+</span> <span class="token function">to_string</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>	<span class="token comment">// 服务器最迫切想知道的时候，客户端有没有数据到达</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	m_channel <span class="token operator">=</span><span class="token keyword">new</span> <span class="token function">Channel</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>FDEvent<span class="token double-colon punctuation">::</span>ReadEvent<span class="token punctuation">,</span> processRead<span class="token punctuation">,</span> processWrite<span class="token punctuation">,</span> destory<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	<span class="token comment">// 把 channel 放到任务循环的任务队列里面</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	evloop<span class="token operator">-></span><span class="token function">AddTask</span><span class="token punctuation">(</span>m_channel<span class="token punctuation">,</span> ElemType<span class="token double-colon punctuation">::</span>ADD<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="读写回调"><a class="anchor" href="#读写回调">#</a> 读写回调</h3><blockquote><p>读事件将调用 <code>HttpRequest</code> 解析，客户端发送的 <code>读取请求</code> 。写事件，将针对读事件将对应的数据 <code>写入缓存区</code> ，由写事件进行发送。但由于 <code>效率的考虑</code> ，在读事件时，已经设置成边 <code>读变发送提高效率</code> ，发送文件也将采用 Linux 内核提供的 <code>sendfile方法</code> ，不读取内核直接发送，比 <code>send</code> 的效率 <code>快</code> 了，很多，在很大程度上，写事件的写功能基本被 <code>架空</code> 。</p></blockquote><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span> <span class="token class-name">TcpConnection</span><span class="token double-colon punctuation">::</span><span class="token function">processRead</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	TcpConnection<span class="token operator">*</span> conn <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>TcpConnection<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token comment">// 接受数据 最后要存储到 readBuf 里面</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token keyword">int</span> socket <span class="token operator">=</span> conn<span class="token operator">-></span>m_channel<span class="token operator">-></span><span class="token function">getSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token keyword">int</span> count <span class="token operator">=</span> conn<span class="token operator">-></span>m_readBuf<span class="token operator">-></span><span class="token function">socketRead</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token comment">//data 起始地址 readPos 该读的地址位置</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"接收到的http请求数据: %s"</span><span class="token punctuation">,</span> conn<span class="token operator">-></span>m_readBuf<span class="token operator">-></span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>		<span class="token comment">// 接受了 http 请求，解析 http 请求</span></pre></td></tr><tr><td data-num="13"></td><td><pre>		</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">MSG_SEND_AUTO</span></span></pre></td></tr><tr><td data-num="15"></td><td><pre>		<span class="token comment">// 添加检测写事件</span></pre></td></tr><tr><td data-num="16"></td><td><pre>		conn<span class="token operator">-></span>m_channel<span class="token operator">-></span><span class="token function">writeEventEnable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>		<span class="token comment">//  MODIFY 修改检测读写事件</span></pre></td></tr><tr><td data-num="18"></td><td><pre>		conn<span class="token operator">-></span>m_evLoop<span class="token operator">-></span><span class="token function">AddTask</span><span class="token punctuation">(</span>conn<span class="token operator">-></span>m_channel<span class="token punctuation">,</span> ElemType<span class="token double-colon punctuation">::</span>MODIFY<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="20"></td><td><pre>		<span class="token keyword">bool</span> flag <span class="token operator">=</span> conn<span class="token operator">-></span>m_request<span class="token operator">-></span><span class="token function">parseHttpRequest</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="21"></td><td><pre>			conn<span class="token operator">-></span>m_readBuf<span class="token punctuation">,</span> conn<span class="token operator">-></span>m_response<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>			conn<span class="token operator">-></span>m_writeBuf<span class="token punctuation">,</span> socket<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flag<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>			<span class="token comment">// 解析失败，回复一个简单的 HTML</span></pre></td></tr><tr><td data-num="26"></td><td><pre>			string errMsg <span class="token operator">=</span> <span class="token string">"Http/1.1 400 Bad Request\r\n\r\n"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>			conn<span class="token operator">-></span>m_writeBuf<span class="token operator">-></span><span class="token function">appendString</span><span class="token punctuation">(</span>errMsg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>	<span class="token keyword">else</span></pre></td></tr><tr><td data-num="31"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>		</pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">MSG_SEND_AUTO  </span><span class="token comment">// 如果被定义，</span></span></pre></td></tr><tr><td data-num="34"></td><td><pre>		<span class="token comment">// 断开连接</span></pre></td></tr><tr><td data-num="35"></td><td><pre>		conn<span class="token operator">-></span>m_evLoop<span class="token operator">-></span><span class="token function">AddTask</span><span class="token punctuation">(</span>conn<span class="token operator">-></span>m_channel<span class="token punctuation">,</span> ElemType<span class="token double-colon punctuation">::</span>DELETE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="37"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>	<span class="token comment">// 断开连接 完全写入缓存区再发送不能立即关闭，还没有发送</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">MSG_SEND_AUTO  </span><span class="token comment">// 如果没有被定义，</span></span></pre></td></tr><tr><td data-num="40"></td><td><pre>	conn<span class="token operator">-></span>m_evLoop<span class="token operator">-></span><span class="token function">AddTask</span><span class="token punctuation">(</span>conn<span class="token operator">-></span>m_channel<span class="token punctuation">,</span> ElemType<span class="token double-colon punctuation">::</span>DELETE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="42"></td><td><pre>	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token comment">// 写回调函数，处理写事件，将 writeBuf 中的数据发送给客户端</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token keyword">int</span> <span class="token class-name">TcpConnection</span><span class="token double-colon punctuation">::</span><span class="token function">processWrite</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>	<span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"开始发送数据了(基于写事件发送)...."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>	TcpConnection<span class="token operator">*</span> conn <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>TcpConnection<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>	<span class="token comment">// 发送数据</span></pre></td></tr><tr><td data-num="51"></td><td><pre>	<span class="token keyword">int</span> count <span class="token operator">=</span> conn<span class="token operator">-></span>m_writeBuf<span class="token operator">-></span><span class="token function">sendData</span><span class="token punctuation">(</span>conn<span class="token operator">-></span>m_channel<span class="token operator">-></span><span class="token function">getSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="53"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>		<span class="token comment">// 判断数据是否全部被发送出去</span></pre></td></tr><tr><td data-num="55"></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span>conn<span class="token operator">-></span>m_writeBuf<span class="token operator">-></span><span class="token function">readableSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="56"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>			<span class="token comment">// 数据发送完毕</span></pre></td></tr><tr><td data-num="58"></td><td><pre>			<span class="token comment">// 1，不再检测写事件 -- 修改 channel 中保存的事件</span></pre></td></tr><tr><td data-num="59"></td><td><pre>			conn<span class="token operator">-></span>m_channel<span class="token operator">-></span><span class="token function">writeEventEnable</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>			<span class="token comment">// 2, 修改 dispatcher 中检测的集合，往 enentLoop 反映模型认为队列节点标记为 modify</span></pre></td></tr><tr><td data-num="61"></td><td><pre>			conn<span class="token operator">-></span>m_evLoop<span class="token operator">-></span><span class="token function">AddTask</span><span class="token punctuation">(</span>conn<span class="token operator">-></span>m_channel<span class="token punctuation">,</span> ElemType<span class="token double-colon punctuation">::</span>MODIFY<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>			<span class="token comment">//3，若不通信，删除这个节点</span></pre></td></tr><tr><td data-num="63"></td><td><pre>			conn<span class="token operator">-></span>m_evLoop<span class="token operator">-></span><span class="token function">AddTask</span><span class="token punctuation">(</span>conn<span class="token operator">-></span>m_channel<span class="token punctuation">,</span> ElemType<span class="token double-colon punctuation">::</span>DELETE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="httprequest"><a class="anchor" href="#httprequest">#</a> <code>HttpRequest</code></h2><blockquote><p>定义 <code>http 请求结构体</code> 添加请求头结点， <code>解析请求行</code> ，头， <code>解析/处理http</code> 请求协议，获取文件类型<br>发送 <code>文件/目录</code> 设置请求 <code>url,Method，Version ,state</code></p></blockquote><h3 id="处理客户端解析请求"><a class="anchor" href="#处理客户端解析请求">#</a> 处理客户端解析请求</h3><blockquote><p>在 <code>while循环内部</code> ，完成对 <code>请求行</code> 和 <code>请求头</code> 的解析。解析完成之后，根据请求行，读取 <code>客户端需要</code> 的数据，并对应进行操作</p></blockquote><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">bool</span> <span class="token class-name">HttpRequest</span><span class="token double-colon punctuation">::</span><span class="token function">parseHttpRequest</span><span class="token punctuation">(</span>Buffer<span class="token operator">*</span> readBuf<span class="token punctuation">,</span> HttpResponse<span class="token operator">*</span> response<span class="token punctuation">,</span> Buffer<span class="token operator">*</span> sendBuf<span class="token punctuation">,</span> <span class="token keyword">int</span> socket<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">bool</span> flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token comment">// 先解析请求行</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token keyword">while</span> <span class="token punctuation">(</span>m_curState <span class="token operator">!=</span>PressState<span class="token double-colon punctuation">::</span>ParseReqDone<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>		<span class="token comment">// 根据请求头目前的请求状态进行选择</span></pre></td></tr><tr><td data-num="8"></td><td><pre>		<span class="token keyword">switch</span> <span class="token punctuation">(</span>m_curState<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>		<span class="token keyword">case</span> PressState<span class="token double-colon punctuation">::</span>ParseReqLine<span class="token operator">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>			flag <span class="token operator">=</span> <span class="token function">parseRequestLine</span><span class="token punctuation">(</span>readBuf<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>			<span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>		<span class="token keyword">case</span> PressState<span class="token double-colon punctuation">::</span>ParseReqHeaders<span class="token operator">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>			flag <span class="token operator">=</span> <span class="token function">parseRequestHeader</span><span class="token punctuation">(</span>readBuf<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>			<span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>		<span class="token keyword">case</span> PressState<span class="token double-colon punctuation">::</span>ParseReqBody<span class="token operator">:</span> <span class="token comment">//post 的请求，咱不做处理</span></pre></td></tr><tr><td data-num="17"></td><td><pre>			<span class="token comment">// 读取 post 数据</span></pre></td></tr><tr><td data-num="18"></td><td><pre>			<span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>		<span class="token keyword">default</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>			<span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flag<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>			<span class="token keyword">return</span> flag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>		<span class="token comment">// 判断是否解析完毕，如果完毕，需要准备回复的数据</span></pre></td></tr><tr><td data-num="27"></td><td><pre>		<span class="token keyword">if</span> <span class="token punctuation">(</span>m_curState <span class="token operator">==</span> PressState<span class="token double-colon punctuation">::</span>ParseReqDone<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre>		<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>			<span class="token comment">// 1，根据解析出的原始数据，对客户端请求做出处理</span></pre></td></tr><tr><td data-num="30"></td><td><pre>			<span class="token function">processHttpRequest</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>			<span class="token comment">// 2, 组织响应数据并发送</span></pre></td></tr><tr><td data-num="32"></td><td><pre>			response<span class="token operator">-></span><span class="token function">prepareMsg</span><span class="token punctuation">(</span>sendBuf<span class="token punctuation">,</span> socket<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>	<span class="token comment">// 状态还原，保证还能继续处理第二条及以后的请求</span></pre></td></tr><tr><td data-num="36"></td><td><pre>	m_curState <span class="token operator">=</span> PressState<span class="token double-colon punctuation">::</span>ParseReqLine<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>	<span class="token comment">// 再解析请求头</span></pre></td></tr><tr><td data-num="38"></td><td><pre>	<span class="token keyword">return</span> flag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="处理客户端请求"><a class="anchor" href="#处理客户端请求">#</a> 处理客户端请求</h3><blockquote><p>根据请求行规则判断是 <code>请求目录</code> ，还是 <code>请求文件</code> ，调用 <code>Buffer</code> 相关 <code>发送目录</code> ，和 <code>发送文件重载函数</code> ，完成 <code>通信任务</code> 。</p></blockquote><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">bool</span> <span class="token class-name">HttpRequest</span><span class="token double-colon punctuation">::</span><span class="token function">processHttpRequest</span><span class="token punctuation">(</span>HttpResponse<span class="token operator">*</span> response<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcasecmp</span><span class="token punctuation">(</span>m_method<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"get"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>   <span class="token comment">//strcasecmp 比较时不区分大小写</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>		<span class="token comment">// 非 get 请求不处理</span></pre></td></tr><tr><td data-num="6"></td><td><pre>		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	m_url <span class="token operator">=</span> <span class="token function">decodeMsg</span><span class="token punctuation">(</span>m_url<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 避免中文的编码问题 将请求的路径转码 linux 会转成 utf8</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token comment">// 处理客户端请求的静态资源 (目录或文件)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> file <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>m_url<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 判断是不是根目录</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>		file <span class="token operator">=</span> <span class="token string">"./"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	<span class="token keyword">else</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>		file <span class="token operator">=</span> m_url<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 指针 + 1 把开始的 / 去掉吧</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>	<span class="token comment">// 判断 file 属性，是文件还是目录</span></pre></td></tr><tr><td data-num="21"></td><td><pre>	<span class="token keyword">struct</span> <span class="token class-name">stat</span> st<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>	<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">stat</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token operator">&amp;</span>st<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//file 文件属性，同时将信息传入 st 保存了文件的大小</span></pre></td></tr><tr><td data-num="23"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>		<span class="token comment">// 文件不存在  -- 回复 404</span></pre></td></tr><tr><td data-num="26"></td><td><pre>		<span class="token comment">//sendHeadMsg(cfd, 404, "Not Found", getFileType(".html"), -1);</span></pre></td></tr><tr><td data-num="27"></td><td><pre>		<span class="token comment">//sendFile ("404.html", cfd); // 发送 404 对应的 html 文件</span></pre></td></tr><tr><td data-num="28"></td><td><pre>		response<span class="token operator">-></span><span class="token function">setFileName</span><span class="token punctuation">(</span><span class="token string">"404.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>		response<span class="token operator">-></span><span class="token function">setStatusCode</span><span class="token punctuation">(</span>StatusCode<span class="token double-colon punctuation">::</span>NotFound<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>		<span class="token comment">// 响应头</span></pre></td></tr><tr><td data-num="31"></td><td><pre>		response<span class="token operator">-></span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">"Content-type"</span><span class="token punctuation">,</span> <span class="token function">getFileType</span><span class="token punctuation">(</span><span class="token string">".html"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>		response<span class="token operator">-></span>sendDataFunc <span class="token operator">=</span> sendFile<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>	response<span class="token operator">-></span><span class="token function">setFileName</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>	response<span class="token operator">-></span><span class="token function">setStatusCode</span><span class="token punctuation">(</span>StatusCode<span class="token double-colon punctuation">::</span>OK<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>	<span class="token comment">// 判断文件类型</span></pre></td></tr><tr><td data-num="39"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">S_ISDIR</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 如果时目录返回 1，不是返回 0</span></pre></td></tr><tr><td data-num="40"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>		<span class="token comment">// 把这个目录中的内容发送给客户端</span></pre></td></tr><tr><td data-num="42"></td><td><pre>		<span class="token comment">//sendHeadMsg(cfd, 200, "OK", getFileType(".html"), (int)st.st_size);</span></pre></td></tr><tr><td data-num="43"></td><td><pre>		<span class="token comment">//sendDir(file, cfd);</span></pre></td></tr><tr><td data-num="44"></td><td><pre>		<span class="token comment">// 响应头</span></pre></td></tr><tr><td data-num="45"></td><td><pre>		response<span class="token operator">-></span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">"Content-type"</span><span class="token punctuation">,</span> <span class="token function">getFileType</span><span class="token punctuation">(</span><span class="token string">".html"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>		response<span class="token operator">-></span>sendDataFunc <span class="token operator">=</span> sendDir<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>	<span class="token keyword">else</span></pre></td></tr><tr><td data-num="49"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>		<span class="token comment">// 把这个文件的内容发给客户端</span></pre></td></tr><tr><td data-num="51"></td><td><pre>		<span class="token comment">//sendHeadMsg(cfd, 200, "OK", getFileType(file), (int)st.st_size);</span></pre></td></tr><tr><td data-num="52"></td><td><pre>		<span class="token comment">//sendFile(file, cfd);</span></pre></td></tr><tr><td data-num="53"></td><td><pre>		<span class="token comment">// 响应头</span></pre></td></tr><tr><td data-num="54"></td><td><pre>		response<span class="token operator">-></span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">"Content-type"</span><span class="token punctuation">,</span> <span class="token function">getFileType</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>		response<span class="token operator">-></span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">"Content-length"</span><span class="token punctuation">,</span> <span class="token function">to_string</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>		response<span class="token operator">-></span>sendDataFunc <span class="token operator">=</span> sendFile<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>	<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="httpresponse"><a class="anchor" href="#httpresponse">#</a> <code>HttpResponse</code></h2><blockquote><p>定义 <code>http响应</code> ， <code>添加响应头</code> ，准备响应的数据</p></blockquote><h1 id="服务器"><a class="anchor" href="#服务器">#</a> 服务器</h1><h2 id="tcpserver"><a class="anchor" href="#tcpserver">#</a> <code>TcpServer</code></h2><blockquote><p><code>服务器类</code> ，复制服务器的初始化， <code>设置监听</code> ， <code>启动服务器</code> ，并接受 <code>主线程的连接请求</code></p></blockquote><p><img data-src="https://mmbiz.qpic.cn/mmbiz_jpg/ORog4TEnkbvYbuq71ib9iaeQVznZ5coWaybIOnzsoQRjxTJYpKVfLRAIX5kbdF90FdlAITz0RZE9bvbkx4PAicLuA/640?wx_fmt=jpeg" alt="TcpServer工作流程" title="TCpServer工作流程"></p><h1 id="主函数"><a class="anchor" href="#主函数">#</a> 主函数</h1><ul><li>传入用户输入的 <code>端口</code> 和 <code>文件夹</code><ul><li>端口将作为服务器 <code>端口</code> ，文件夹将作为浏览器访问的文件夹</li></ul></li><li>初始化 <code>TcpServer</code> 服务器实例 - 传入端口和 <code>初始化线程个数</code></li><li>运行服务器</li></ul><figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"TcpServer.h"</span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">// 初始化监听的套接字</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">//argc 输入参数的个数</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">//argv [0] 可执行程序的名称 </span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">//argv [1] 传入的第一个参数， port</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">//argv [2] 传入的第二个参数   path</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"./a.out port path\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> port <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span><span class="token punctuation">)</span><span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">// 切换服务器的根目录，将根目录当前目录切换到其它目录</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token function">chdir</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">// 启动服务器</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment">// VS code 调试</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> port <span class="token operator">=</span> <span class="token number">8080</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token function">chdir</span><span class="token punctuation">(</span><span class="token string">"/home/foryouos/blog"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">// 创建服务器实例</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    TcpServer<span class="token operator">*</span> server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">TcpServer</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token comment">// 服务器运行 - 启动线程池 - 对监听的套接字进行封装，并放到主线程的任务队列，启动反应堆模型</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token comment">// 底层的 epoll 也运行起来，</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    server<span class="token operator">-></span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h1 id="初始化tcpserver"><a class="anchor" href="#初始化tcpserver">#</a> 初始化 <code>TcpServer</code></h1><p><img data-src="https://mmbiz.qpic.cn/mmbiz_jpg/ORog4TEnkbtycdzkcLic0JLia7rAVa6cia5eS1xx3fWYlEUTcSw2Z0ethrjONW7NsSaSNNicZgpYCk8NAPzoiaIeqcw/640?wx_fmt=jpeg" alt="初始化TcpServer" title="初始化TcpServer"></p><h1 id="启动tcpserver"><a class="anchor" href="#启动tcpserver">#</a> 启动 <code>TcpServer</code></h1><p><img data-src="https://mmbiz.qpic.cn/mmbiz_jpg/ORog4TEnkbvYbuq71ib9iaeQVznZ5coWayuDicPlYutY6icNuYHb5WKQhPib0BkvU6WfFWzr3dUcicfFTiaq0sJjTpAicg/640?wx_fmt=jpeg" alt="启动TcpServer" title="启动TCpServer"></p><h1 id="检测到客户端请求"><a class="anchor" href="#检测到客户端请求">#</a> 检测到客户端请求</h1><p><img data-src="https://mmbiz.qpic.cn/mmbiz_jpg/ORog4TEnkbvYbuq71ib9iaeQVznZ5coWaybSQDFav1DdHFxBZibVBXqrYg9mNEEaZMdZVZibvwtDF0A8fRZSGoFEZA/640?wx_fmt=jpeg" alt="客户端请求" title="客户端请求"></p><h1 id="详细代码"><a class="anchor" href="#详细代码">#</a> 详细代码</h1><blockquote><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2ZvcnlvdW9zL2NwcHNlcnZlci1saW51eC90cmVlL21haW4vY19zaW1wbGVfc2VydmVyL2NwcF9zZXJ2ZXI=">Github</span><sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup></p></blockquote><hr class="footnotes-sep"><section class="footnotes"><ol class="footnotes-list"><li id="fn1" class="footnote-item"><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2ZvcnlvdW9zL2NwcHNlcnZlci1saW51eC90cmVlL21haW4vY19zaW1wbGVfc2VydmVyL2NwcF9zZXJ2ZXI=">https://github.com/foryouos/cppserver-linux/tree/main/c_simple_server/cpp_server</span> <a href="#fnref1" class="footnote-backref">↩︎</a></p></li></ol></section><div class="tags"><a href="/tags/Linux/" rel="tag"><i class="ic i-tag"></i>Linux</a><a href="/tags/C/" rel="tag"><i class="ic i-tag"></i>C++</a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/" rel="tag"><i class="ic i-tag"></i>计算机科学</a><a href="/tags/%E5%90%8E%E5%8F%B0%E6%9C%8D%E5%8A%A1%E5%99%A8/" rel="tag"><i class="ic i-tag"></i>后台服务器</a></div></div><footer><div class="meta"><span class="icon"><i class="ic i-eye"></i></span><span>此文章已被阅读次数:</span><span class="waline-pageview-count" id="twikoo_visitors" data-path="computer-science/cpp/course-4/cpp高反应堆模型/">正在加载...</span><span class="item"><span class="icon"><i class="ic i-calendar-check"></i></span><span class="text">更新于</span><time title="修改时间：2023-07-04 17:13:53" itemprop="dateModified" datetime="2023-07-04T17:13:53+08:00">2023-07-04</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i>赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/assets/wechatpay.png" alt="YuHeShui 微信支付"><p>微信支付</p></div><div><img data-src="/assets/alipay.png" alt="YuHeShui 支付宝"><p>支付宝</p></div><div><img data-src="/assets/paypal.png" alt="YuHeShui 贝宝"><p>贝宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者：</strong>YuHeShui<i class="ic i-at"><em>@</em></i>瓶子的跋涉</li><li class="link"><strong>本文链接：</strong><a href="https://www.blog.foryouos.cn/computer-science/cpp/course-4/cpp%E9%AB%98%E5%8F%8D%E5%BA%94%E5%A0%86%E6%A8%A1%E5%9E%8B/" title="Linux后台服务器C++">https://www.blog.foryouos.cn/computer-science/cpp/course-4/cpp高反应堆模型/</a></li><li class="license"><strong>版权声明：</strong>本站所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener external nofollow noreferrer" target="_blank"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/computer-science/cpp/course-6/B%E6%A0%91/" rel="prev" itemprop="url" data-background-image="https:&#x2F;&#x2F;i.imgtg.com&#x2F;2023&#x2F;07&#x2F;01&#x2F;Okdrlc.jpg" title="B树"><span class="type">上一篇</span><span class="category"><i class="ic i-flag"></i>零声笔记</span><h3>B树</h3></a></div><div class="item right"><a href="/computer-science/cpp/course-2/cpp%E6%96%B0%E7%89%B9%E6%80%A7%E5%8F%98%E9%87%8F/" rel="next" itemprop="url" data-background-image="https:&#x2F;&#x2F;i.imgtg.com&#x2F;2023&#x2F;07&#x2F;04&#x2F;OxnKHb.webp" title="C++11新特性变量"><span class="type">下一篇</span><span class="category"><i class="ic i-flag"></i>汇编与STl新特征</span><h3>C++11新特性变量</h3></a></div></div><div class="wrap" id="wcomments"></div><script type="module" data-pjax="data-pjax">import { init } from 'https://unpkg.com/@waline/client@v2/dist/waline.mjs';

setTimeout(function () {
    init({
        el: '#wcomments',
        serverURL: 'https://foryouos.netlify.app/.netlify/functions/comment',
        lang: 'zh-CN',
        locale: {},
        emoji: ["https://unpkg.com/@waline/emojis@1.0.1/weibo","https://unpkg.com/@waline/emojis@1.0.1/alus","https://unpkg.com/@waline/emojis@1.0.1/bilibili","https://unpkg.com/@waline/emojis@1.0.1/qq","https://unpkg.com/@waline/emojis@1.0.1/tieba","https://unpkg.com/@waline/emojis@1.0.1/tw-emoji"],
        meta: ["nick","mail","link"],
        requiredMeta: ["nick","mail"],
        wordLimit: 0,
        pageSize: 10,
        pageview: true,
        path: window.location.pathname,
        dark: 'html[data-theme="dark"]'
    });
}, 1000)</script></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Ereactor%E9%AB%98%E5%B9%B6%E5%8F%91%E6%9C%8D%E5%8A%A1%E5%99%A8-c"><span class="toc-number">1.</span> <span class="toc-text">基于 Reactor 高并发服务器 C++</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%8D%E5%BA%94%E5%A0%86%E6%A8%A1%E5%9E%8B"><span class="toc-number">2.</span> <span class="toc-text">反应堆模型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#channel"><span class="toc-number">2.1.</span> <span class="toc-text">Channel</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#channel%E6%B7%BB%E5%8A%A0%E5%86%99%E5%92%8C%E5%88%A4%E6%96%AD"><span class="toc-number">2.2.</span> <span class="toc-text">Channel 添加写和判断</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dispatcher"><span class="toc-number">2.3.</span> <span class="toc-text">Dispatcher</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%89%E6%8B%A9%E5%8F%8D%E5%BA%94%E5%A0%86%E6%A8%A1%E5%9E%8B"><span class="toc-number">2.4.</span> <span class="toc-text">选择反应堆模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#eventloop"><span class="toc-number">2.5.</span> <span class="toc-text">EventLoop</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A7%81%E6%9C%89%E5%87%BD%E6%95%B0%E5%8F%98%E9%87%8F"><span class="toc-number">2.5.1.</span> <span class="toc-text">私有函数变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%BA%94%E5%A0%86%E8%BF%90%E8%A1%8C"><span class="toc-number">2.5.2.</span> <span class="toc-text">反应堆运行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#enactive"><span class="toc-number">2.5.3.</span> <span class="toc-text">enactive</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.5.4.</span> <span class="toc-text">添加任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.5.5.</span> <span class="toc-text">处理任务</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B"><span class="toc-number">3.</span> <span class="toc-text">多线程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#threadpool"><span class="toc-number">3.1.</span> <span class="toc-text">ThreadPool</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E8%BF%90%E8%A1%8C%E5%88%9B%E5%BB%BA%E5%AD%90%E5%B7%A5%E4%BD%9C%E7%BA%BF%E7%A8%8B"><span class="toc-number">3.1.1.</span> <span class="toc-text">线程池运行创建子工作线程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%96%E5%87%BA%E5%B7%A5%E4%BD%9C%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%B8%AD%E7%9A%84eventloop"><span class="toc-number">3.1.2.</span> <span class="toc-text">取出工作线程池中的 EventLoop</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E7%BA%BF%E7%A8%8B%E8%BF%90%E8%A1%8C"><span class="toc-number">3.1.3.</span> <span class="toc-text">工作线程运行</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#io-%E6%A8%A1%E5%9E%8B"><span class="toc-number">4.</span> <span class="toc-text">IO 模型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#buffer"><span class="toc-number">4.1.</span> <span class="toc-text">Buffer</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E7%9B%AE%E5%BD%95"><span class="toc-number">4.1.1.</span> <span class="toc-text">发送目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E6%96%87%E4%BB%B6"><span class="toc-number">4.1.2.</span> <span class="toc-text">发送文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#tcpconnection"><span class="toc-number">4.2.</span> <span class="toc-text">TcpConnection</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">4.2.1.</span> <span class="toc-text">初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BB%E5%86%99%E5%9B%9E%E8%B0%83"><span class="toc-number">4.2.2.</span> <span class="toc-text">读写回调</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#httprequest"><span class="toc-number">4.3.</span> <span class="toc-text">HttpRequest</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%A7%A3%E6%9E%90%E8%AF%B7%E6%B1%82"><span class="toc-number">4.3.1.</span> <span class="toc-text">处理客户端解析请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%B7%E6%B1%82"><span class="toc-number">4.3.2.</span> <span class="toc-text">处理客户端请求</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#httpresponse"><span class="toc-number">4.4.</span> <span class="toc-text">HttpResponse</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">5.</span> <span class="toc-text">服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#tcpserver"><span class="toc-number">5.1.</span> <span class="toc-text">TcpServer</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%BB%E5%87%BD%E6%95%B0"><span class="toc-number">6.</span> <span class="toc-text">主函数</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96tcpserver"><span class="toc-number">7.</span> <span class="toc-text">初始化 TcpServer</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8tcpserver"><span class="toc-number">8.</span> <span class="toc-text">启动 TcpServer</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A3%80%E6%B5%8B%E5%88%B0%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%B7%E6%B1%82"><span class="toc-number">9.</span> <span class="toc-text">检测到客户端请求</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AF%A6%E7%BB%86%E4%BB%A3%E7%A0%81"><span class="toc-number">10.</span> <span class="toc-text">详细代码</span></a></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/computer-science/cpp/course-4/cpp%E5%AE%9E%E7%8E%B0%E9%93%B6%E8%A1%8C%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/" rel="bookmark" title="C++实现银行管理系统">C++实现银行管理系统</a></li><li><a href="/computer-science/cpp/course-4/Qt%E5%81%9C%E8%BD%A6%E5%9C%BA%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/" rel="bookmark" title="Qt停车场管理系统+OpenCV+EasyPR+MySQL">Qt停车场管理系统+OpenCV+EasyPR+MySQL</a></li><li><a href="/computer-science/cpp/course-4/C%E5%91%98%E5%B7%A5%E5%B7%A5%E8%B5%84%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/" rel="bookmark" title="C实现员工工资管理系统">C实现员工工资管理系统</a></li><li><a href="/computer-science/cpp/course-4/Qt%E5%A4%9A%E7%BA%BF%E7%A8%8BTCP/" rel="bookmark" title="Qt多线程TCP">Qt多线程TCP</a></li><li><a href="/computer-science/cpp/course-4/Linux%E5%90%8E%E5%8F%B0%E6%9C%8D%E5%8A%A1%E5%99%A8simple/" rel="bookmark" title="Linux后台服务器simple">Linux后台服务器simple</a></li><li class="active"><a href="/computer-science/cpp/course-4/cpp%E9%AB%98%E5%8F%8D%E5%BA%94%E5%A0%86%E6%A8%A1%E5%9E%8B/" rel="bookmark" title="Linux后台服务器C++">Linux后台服务器C++</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="YuHeShui" data-src="/assets/avatar.jpg"><p class="name" itemprop="name">YuHeShui</p><div class="description" itemprop="description">瓶子的跋涉 & 编程笔记</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">69</span><span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">16</span><span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">37</span><span class="name">标签</span></a></div></nav><div class="social"><a href="https://github.com/foryouos" class="item github" rel="noopener external nofollow noreferrer" title="https:&#x2F;&#x2F;github.com&#x2F;foryouos" target="_blank"><i class="ic i-github"></i></a><a href="https://www.zhihu.com/people/foryouos" class="item zhihu" rel="noopener external nofollow noreferrer" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;foryouos" target="_blank"><i class="ic i-zhihu"></i></a><a href="mailto:foryouos@mail.com" class="item email" rel="noopener external nofollow noreferrer" title="mailto:foryouos@mail.com" target="_blank"><i class="ic i-envelope"></i></a></div><div class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="javascript:void(0);" rel="external nofollow noreferrer"><i class="ic i-user"></i>关于</a><ul class="submenu"><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于本站</a></li><li class="item"><a href="/admiration/" rel="section"><i class="ic i-coffee"></i>赞赏博主</a></li></ul></li><li class="item dropdown"><a href="javascript:void(0);" rel="external nofollow noreferrer"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友链</a></li><li class="item dropdown"><a href="javascript:void(0);" rel="external nofollow noreferrer"><i class="ic i-user"></i>外链</a><ul class="submenu"><li class="item"><a href="https://www.foryouos.cn/" rel="noopener external nofollow noreferrer" target="_blank"><i class="ic i-user"></i>主页</a></li><li class="item"><a href="https://www.so.foryouos.cn/" rel="noopener external nofollow noreferrer" target="_blank"><i class="ic i-magic"></i>搜索</a></li><li class="item"><a href="https://imgtg.com/foryouos" rel="noopener external nofollow noreferrer" target="_blank"><i class="ic i-coffee"></i>图库</a></li></ul></li></div></div></div></div><ul id="quick"><li class="prev pjax"><a href="/computer-science/cpp/course-2/cpp%E6%96%B0%E7%89%B9%E6%80%A7%E5%8F%98%E9%87%8F/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/computer-science/cpp/course-6/B%E6%A0%91/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/BIOS/" title="分类于BIOS">BIOS</a></div><span><a href="/BIOS/EDK2%E4%B8%8E%E5%8F%8C%E7%B3%BB%E7%BB%9F/">EDK2安装与双系统</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于计算机科学">计算机科学</a><i class="ic i-angle-right"></i><a href="/categories/computer-science/cpp/" title="分类于C++">C++</a><i class="ic i-angle-right"></i><a href="/categories/computer-science/cpp/course-5/" title="分类于Qt">Qt</a></div><span><a href="/computer-science/cpp/course-5/Qt%E4%BF%A1%E5%8F%B7%E4%B8%8E%E6%A7%BD/">Qt信号与槽</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/BIOS/" title="分类于BIOS">BIOS</a></div><span><a href="/BIOS/UEFI%E4%B8%83%E9%98%B6%E6%AE%B5/">UEFI概述</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于计算机科学">计算机科学</a><i class="ic i-angle-right"></i><a href="/categories/computer-science/cpp/" title="分类于C++">C++</a><i class="ic i-angle-right"></i><a href="/categories/computer-science/cpp/course-1/" title="分类于郑莉老师C++语言程序设计">郑莉老师C++语言程序设计</a></div><span><a href="/computer-science/cpp/course-1/cpp%E6%A8%A1%E5%9D%97%E4%B8%8E%E7%BE%A4%E4%BD%93%E6%95%B0%E6%8D%AE/">C++模块与群体数据</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于计算机科学">计算机科学</a><i class="ic i-angle-right"></i><a href="/categories/computer-science/cpp/" title="分类于C++">C++</a><i class="ic i-angle-right"></i><a href="/categories/computer-science/cpp/course-2/" title="分类于汇编与STl新特征">汇编与STl新特征</a></div><span><a href="/computer-science/cpp/course-2/STL%E9%A1%BA%E5%BA%8F%E5%AE%B9%E5%99%A8/">STL顺序容器</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于计算机科学">计算机科学</a><i class="ic i-angle-right"></i><a href="/categories/computer-science/web/" title="分类于web">web</a><i class="ic i-angle-right"></i><a href="/categories/computer-science/web/front/" title="分类于前端">前端</a></div><span><a href="/computer-science/web/front/%E9%9A%8F%E6%9C%BA%E5%9B%BE%E7%89%87API/">Github page随机图片API</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于计算机科学">计算机科学</a><i class="ic i-angle-right"></i><a href="/categories/computer-science/cpp/" title="分类于C++">C++</a><i class="ic i-angle-right"></i><a href="/categories/computer-science/cpp/course-3/" title="分类于C++开源库">C++开源库</a></div><span><a href="/computer-science/cpp/course-3/C%E5%92%8CcppMySQL%20API%E8%B0%83%E7%94%A8/">C和C++调用MySQL API</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于计算机科学">计算机科学</a><i class="ic i-angle-right"></i><a href="/categories/computer-science/Linux/" title="分类于Linux">Linux</a></div><span><a href="/computer-science/Linux/cmake/">Cmake笔记</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于计算机科学">计算机科学</a><i class="ic i-angle-right"></i><a href="/categories/computer-science/cpp/" title="分类于C++">C++</a><i class="ic i-angle-right"></i><a href="/categories/computer-science/cpp/course-4/" title="分类于C和C++项目">C和C++项目</a></div><span><a href="/computer-science/cpp/course-4/Linux%E5%90%8E%E5%8F%B0%E6%9C%8D%E5%8A%A1%E5%99%A8simple/">Linux后台服务器simple</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于计算机科学">计算机科学</a><i class="ic i-angle-right"></i><a href="/categories/computer-science/cpp/" title="分类于C++">C++</a><i class="ic i-angle-right"></i><a href="/categories/computer-science/cpp/course-2/" title="分类于汇编与STl新特征">汇编与STl新特征</a></div><span><a href="/computer-science/cpp/course-2/STL%E5%AE%B9%E5%99%A8%E9%80%82%E9%85%8D%E5%99%A8/">STL容器适配器</a></span></li></ul></div><div class="rpost pjax"><h2>最新评论</h2><ul class="leancloud-recent-comment" id="new-comment"><li class="item" v-for="com in coms"><a v-bind:href="root + com.href" data-pjax-state="data-pjax-state"><span class="breadcrumb">{{com.nick}} @ {{com.time}}</span><span>{{com.text}}<br></span></a></li></ul></div></div><div class="status"><div class="copyright">&copy; 2022 -<span itemprop="copyrightYear">2023</span><span class="with-love"><i class="ic i-sakura rotate"></i></span><span class="author" itemprop="copyrightHolder">YuHeShui @ foryouos</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i></span><span title="站点总字数">759k 字</span><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="ic i-coffee"></i></span><span title="站点阅读时长">11:30</span></div><div class="powered-by">基于 <a href="https://hexo.io/" rel="noopener external nofollow noreferrer" target="_blank">Hexo</a> & Theme.<a href="https://github.com/theme-shoka-x/hexo-theme-shokaX/" rel="noopener external nofollow noreferrer" target="_blank">ShokaX</a></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"computer-science/cpp/course-4/cpp高反应堆模型/",favicon:{show:"不负韶华",hide:"以梦为马！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,chart:!1,copy_tex:!1,katex:!1,mermaid:!1,audio:void 0,fancybox:!0,nocopy:!1,outime:!0,template:'<div class="note warning"><p><span class="label warning">文章时效性提示</span><br>这是一篇发布于 {{publish}} 天前，最后一次更新在 {{updated}} 天前的文章，部分信息可能已经发生改变，请注意甄别。</p></div>',quiz:{choice:"单选题",multiple:"多选题",true_false:"判断题",essay:"问答题",gap_fill:"填空题",mistake:"错题备注"},ignores:[e=>e.includes("#"),e=>new RegExp(LOCAL.path+"$").test(e),[]]}</script><script src="https://polyfill.io/v3/polyfill.min.js?features=default,fetch"></script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/pace/1.0.2/pace.min.js"></script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/algoliasearch/4.12.1/algoliasearch-lite.umd.min.js"></script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/instantsearch.js/4.39.0/instantsearch.production.min.js"></script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/quicklink/2.2.0/quicklink.umd.min.js"></script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/??jquery/3.5.1/jquery.min.js,fancybox/3.5.7/jquery.fancybox.min.js,justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js" async></script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/KaTeX/0.12.0/contrib/copy-tex.min.js" async></script><script src="https://unpkg.com/theme-shokax-pjax@latest/pjax.shokax.min.js"></script><script src="https://unpkg.com/theme-shokax-anime@latest/anime.shokax.min.js"></script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/lozad.js/1.16.0/lozad.min.js"></script><script src="https://unpkg.com/frappe-charts@1.5.0/dist/frappe-charts.min.iife.js"></script><script src="/js/app.js?v=0.3.5"></script><script data-pjax="data-pjax">var _hmt=_hmt||[];!function(){var e=document.createElement("script"),t=(e.src="https://hm.baidu.com/hm.js?e3ba29befb93fdf32bbc553d0e5bee92",e.async=!0,document.getElementsByTagName("script")[0]);t.parentNode.insertBefore(e,t)}()</script><script type="module" data-pjax>let items = []
        import { RecentComments } from 'https://unpkg.com/@waline/client@v2/dist/waline.mjs'
        RecentComments({
          serverURL: 'https://foryouos.netlify.app/.netlify/functions/comment',
          count: 10,
        }).then(({ comments }) => {
          comments.forEach(function (item) {
              let cText = (item.orig.length > 50) ? item.orig.substring(0,50)+'...' : item.orig
              item.url = item.url !== '/' ?  '/' + item.url : item.url;
              const siteLink = item.url + "#" + item.objectId
              items.push({
                  href: siteLink,
                  nick: item.nick,
                  time: item.insertedAt.split('T').shift(),
                  text: cText
              })
          })
          Vue.createApp({
            data() {
                return {
                    coms: items,
                    root: ''
                }
            }
          }).mount('#new-comment')
        }).catch(function (err) {
          console.error(err)
        })</script></body></html><!-- rebuild by hexo-renderer-multi-next-markdown-it -->